name: Build ncclient Binaries

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v0.1.5)
  pull_request:
    paths:
      - 'client/binaries/**'
      - 'client/windows/**'
      - 'client/ncclient.py'
      - '.github/workflows/build-ncclient-binaries.yml'
  workflow_dispatch:  # Allow manual trigger from Actions tab

# Required for creating releases and uploading release assets
permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Continue building other platforms if one fails
      matrix:
        include:
          # Linux builds (ubuntu-22.04 for GLIBC 2.35 compatibility with Ubuntu 22.04 LTS)
          - os: ubuntu-22.04
            artifact_name: ncclient
            asset_name: ncclient-linux-amd64
            platform: Linux (x86_64)
            arch: x64
          - os: ubuntu-22.04
            artifact_name: ncclient
            asset_name: ncclient-linux-arm64
            platform: Linux (ARM64)
            arch: arm64
          
          # Windows builds (GitHub has no Windows ARM64 runners; omit windows-arm64)
          - os: windows-latest
            artifact_name: ncclient.exe
            asset_name: ncclient-windows-amd64.exe
            platform: Windows (x86_64)
            arch: x64
          
          # macOS builds
          - os: macos-15-intel  # Intel Mac (macos-13 retired)
            artifact_name: ncclient
            asset_name: ncclient-macos-amd64
            platform: macOS (Intel)
            arch: x64
          - os: macos-latest  # Apple Silicon (macos-15 arm64)
            artifact_name: ncclient
            asset_name: ncclient-macos-arm64
            platform: macOS (ARM64)
            arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Linux ARM64 builds in Docker (no host Python); other jobs need Python on the host
      - name: Set up Python
        if: runner.os != 'Linux' || matrix.arch != 'arm64'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      - name: Set up QEMU (for Linux ARM64)
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install dependencies
        if: runner.os != 'Linux' || matrix.arch != 'arm64'
        run: |
          python -m pip install --upgrade pip
          pip install -r client/binaries/requirements.txt
          pip install -r client/requirements.txt

      - name: Build executable (native)
        if: matrix.arch == 'x64' || runner.os == 'macOS'
        working-directory: client/binaries
        run: python build.py

      - name: Build executable (Linux ARM64 via Docker)
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/work" \
            -w /work/client/binaries \
            python:3.11-slim \
            bash -c "
              apt-get update && apt-get install -y binutils &&
              pip install --upgrade pip &&
              pip install -r requirements.txt &&
              pip install -r ../requirements.txt &&
              python build.py
            "

      - name: Build executable (Windows ARM64)
        if: runner.os == 'Windows' && matrix.arch == 'arm64'
        working-directory: client/binaries
        run: python build.py
        env:
          # PyInstaller will detect ARM64 from Python architecture
          PYINSTALLER_TARGET_ARCH: arm64

      - name: Run tests (native architectures only)
        if: matrix.arch == 'x64' || runner.os == 'macOS'
        working-directory: client/binaries
        run: python build.py --test
        continue-on-error: true  # ARM64 builds may not run on x64 runners

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p artifacts
          cp client/binaries/dist/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}
          # Make executable on Unix systems
          if [ "$RUNNER_OS" != "Windows" ]; then
            chmod +x artifacts/${{ matrix.asset_name }}
          fi

      - name: Display file info
        shell: bash
        run: |
          ls -lh artifacts/
          file artifacts/${{ matrix.asset_name }} || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: artifacts/${{ matrix.asset_name }}
          if-no-files-found: error

  # Build Windows tray app with bundled Nebula
  build-windows-tray:
    name: Build Windows Tray App
    runs-on: windows-latest
    needs: build  # Wait for CLI build to complete
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: x64
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r client/requirements.txt
          pip install -r client/windows/requirements.txt
          pip install pyinstaller
      
      - name: Build tray app (with bundled Nebula)
        working-directory: client/windows
        run: python build.py
      
      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p artifacts
          cp client/windows/dist/ncclient-tray.exe artifacts/ncclient-tray-windows-amd64.exe
      
      - name: Display file info
        shell: bash
        run: |
          ls -lh artifacts/
          file artifacts/ncclient-tray-windows-amd64.exe || true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ncclient-tray-windows-amd64.exe
          path: artifacts/ncclient-tray-windows-amd64.exe
          if-no-files-found: error

  # Upload all binaries and checksums to GitHub Release (single job to avoid concurrent finalization)
  upload-release:
    name: Upload to Release
    needs: [build, build-windows-tray]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Flatten and prepare release files
        run: |
          cd artifacts
          for d in */; do
            [ ! -d "$d" ] && continue
            d="${d%/}"
            f=$(find "$d" -maxdepth 1 -type f -print -quit)
            [ -z "$f" ] && continue
            mv "$f" "./.tmp_$d"
            rmdir "$d" 2>/dev/null || true
            mv "./.tmp_$d" "./$d"
          done
          sha256sum ncclient* > SHA256SUMS.txt
          echo "=== Release files ==="
          ls -la
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          files: artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: false
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Generate checksums artifact (for Actions UI; release gets checksums from upload-release job)
  checksums:
    name: Generate Checksums
    needs: [build, build-windows-tray]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          # Each artifact is in its own subdirectory (same name as file); move files out
          for d in */; do
            [ ! -d "$d" ] && continue
            d="${d%/}"
            f=$(find "$d" -maxdepth 1 -type f -print -quit)
            [ -z "$f" ] && continue
            mv "$f" "./.tmp_$d"
            rmdir "$d" 2>/dev/null || true
            mv "./.tmp_$d" "./$d"
          done
          sha256sum ncclient* > SHA256SUMS.txt
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      - name: Upload checksums artifact
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: artifacts/SHA256SUMS.txt

  # Summary job to report build status
  summary:
    name: Build Summary
    needs: [build, build-windows-tray]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Build completed!"
          echo "Artifacts are available in the Actions tab."
          if [ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]; then
            echo "Release binaries have been uploaded to the release."
          fi
